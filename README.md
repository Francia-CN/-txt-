======================================================================
# 多格式文档批量转换txt工具 (v1.0)
======================================================================

一个高效、健壮、可扩展的命令行工具，用于将多种格式的文档（如 EPUB, MOBI, PDF, DOCX）批量转换为纯文本（.txt）文件。

## ✨ 主要特性

- **多格式支持**: 原生支持对 `.epub`, `.docx`, `.pdf` 格式的文本提取，并可借助 Calibre 环境支持 `.mobi` 和 `.azw3` 等更多电子书格式。
- **高性能**: 利用多进程并行处理，能充分利用现代多核 CPU 的性能，大幅缩短大批量文件的转换时间。
- **高度健壮**: 对加密文件、内容为空、格式不规范等异常情况有良好的处理和回退机制，确保单个文件的失败不影响整体任务。
- **用户友好**:
  - **一键运行**: 提供 `run.bat` 脚本，方便 Windows 用户直接运行。
  - **实时进度**: 提供实时进度条（tqdm），直观展示处理进度。
  - **彩色输出**: 在终端使用彩色状态输出，转换结果一目了然。
  - **详细日志**: 为每次运行生成详细的日志报告，便于排查问题。
- **灵活配置**: 支持通过命令行参数自定义并发进程数、单个文件处理超时时间、包含/排除特定文件类型等。
- **安全可靠**: 对于清空输出目录等危险操作，需要用户显式授权，防止意外数据丢失。
- **易于扩展**: 采用策略模式设计，添加对新文件格式的支持非常简单。

## 🚀 快速开始 (Windows 用户)

为了方便 Windows 用户，项目提供了一个一键执行脚本 `run.bat`。

1.  **准备文件**: 将所有需要转换的文档放入 `input` 文件夹。
2.  **双击运行**: 直接双击 `run.bat` 文件。
3.  **等待完成**: 脚本将自动开始转换，处理后的 `.txt` 文件会出现在 `output` 文件夹中。

你也可以在 `run.bat` 上右键，选择“编辑”，在 `python run.py %*` 后面添加命令行参数，以实现更复杂的操作。例如，要指定其他目录：
```batch
@echo off
python run.py "D:\我的书籍" "D:\转换结果" %*
pause
```

## 📚 支持格式

| 格式 | 依赖库/工具 | 处理方式 |
| :--- | :--- | :--- |
| `.epub` | `lxml`, `beautifulsoup4` | **转换为 .txt** (内置解析器) |
| `.docx` | `python-docx` | **转换为 .txt** (内置解析器) |
| `.pdf` | `PyMuPDF` | **转换为 .txt** (内置解析器) |
| `.mobi` | Calibre | **转换为 .txt** (调用 `ebook-convert`) |
| `.azw3` | Calibre | **转换为 .txt** (调用 `ebook-convert`) |
| 其他格式 | _无_ | **直接复制**到输出目录 |

## ⚙️ 环境要求与安装

请按顺序完成以下步骤：

### 步骤 1: 安装 Python

确保您已安装 Python 3.7 或更高版本。安装时，建议勾选 "Add Python to PATH" 选项。

### 步骤 2: 安装 Python 依赖库

我们强烈推荐使用 `requirements.txt` 文件来一次性安装所有必要的库。在项目根目录下打开命令行（或 PowerShell），运行：

```bash
pip install -r requirements.txt
```

这将会安装包括核心库和所有可选格式支持的库 (`lxml`, `beautifulsoup4`, `tqdm`, `python-docx`, `PyMuPDF`)。

### 步骤 3: 安装 Calibre (可选，用于转换 .mobi/.azw3)

如果您需要转换 `.mobi` 或 `.azw3` 格式，您必须安装 Calibre 软件。

- **下载地址**: [https://calibre-ebook.com/download](https://calibre-ebook.com/download)

**重要提示**: 安装 Calibre 后，请确保其命令行工具 (`ebook-convert`) 所在的路径已被添加到系统的环境变量 `PATH` 中。这通常在安装过程中可以自动完成。

您可以在终端中运行以下命令来检查 `ebook-convert` 是否配置成功：

```bash
ebook-convert --version
```

如果命令成功执行并返回版本号，则表示配置正确。

## USAGE

### 1. 准备目录结构

- **输入目录**: 默认读取名为 `input` 的文件夹。您可以将所有待转换的文档放入此文件夹（支持任意层级的子文件夹）。
- **输出目录**: 转换后的文件将保存到 `output` 文件夹中，并保持与输入目录相同的目录结构。

### 2. 运行脚本

你可以通过 `run.bat` (Windows) 或直接使用 `python` 命令来运行此工具。

**基本用法** (处理 `input` 目录, 输出到 `output` 目录)
```bash
python run.py
```

**指定输入/输出目录**
```bash
python run.py ./我的书籍 ./转换结果
```

**指定进程数并清空输出目录** (使用 8 个进程，并在开始前强制清空 `texts` 目录)
> **警告**: `--clean-output` 会删除输出目录下的所有内容，请谨慎使用！
```bash
python run.py ./books ./texts -t 8 --clean-output
```

**只转换特定类型的文件** (仅处理目录中的 .epub 和 .pdf 文件)```bash
python run.py ./in ./out --include .epub,.pdf
```

**排除特定类型的文件** (处理所有支持的文件，但跳过所有的图片和压缩包)
```bash
python run.py ./in ./out --exclude .jpg,.png,.zip
```

### 3. 命令行参数详解

| 参数 | 别名 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `input` | | `string` | `input` | 输入目录的路径。 |
| `output` | | `string` | `output` | 输出目录的路径。 |
| `--threads` | `-t` | `int` | 系统CPU核心数 | 用于处理文件的并发进程数量。 |
| `--timeout` | | `int` | `120` | 单个文件的最大处理时间（秒），超时则任务终止。 |
| `--clean-output` | | `flag` | `False` | **危险操作!** 如果指定，将在开始前清空已存在的输出目录。 |
| `--include` | | `string` | `None` | 只处理指定后缀的文件，多个后缀用逗号分隔 (例: `.epub,.pdf`)。 |
| `--exclude` | | `string` | `None` | 排除指定后缀的文件，多个后缀用逗号分隔 (例: `.jpg,.zip`)。 |
| `--no-color` | | `flag` | `False` | 如果指定，禁用所有彩色的控制台输出。 |
| `--help` | `-h` | `flag` | | 显示帮助信息并退出。 |

## 📁 最终目录结构

执行脚本后，您的项目目录将如下所示：
```
.
├── input/            # 你的原始文件放在这里
│   ├── book1.epub
│   ├── subfolder/
│   │   └── report.docx
│   └── picture.jpg
│
├── output/           # 转换后的 .txt 文件会在这里生成
│   ├── book1.txt
│   ├── subfolder/
│   │   └── report.txt
│   └── picture.jpg   # 不支持转换的文件被直接复制
│
├── logs/             # 日志文件夹
│   └── conversion_YYYYMMDD_HHMMSS.log # 记录了每次运行的详细信息
│
├── run.py            # 主脚本
├── run.bat           # (Windows) 一键运行脚本
└── requirements.txt  # Python 依赖列表
```

## 💡 工作原理

- **策略模式**: 脚本内部使用一个字典（`PROCESSOR_STRATEGIES`）将文件后缀映射到对应的处理函数。
- **多进程池**: 利用 `concurrent.futures.ProcessPoolExecutor` 创建一个进程池，将文件处理任务异步提交，实现并行化处理。
- **EPUB 健壮解析**: `handle_epub` 函数在解析时会首先尝试使用严格的 XML 解析器，如果遇到不规范的 XML，它会自动切换到容错性更强的 HTML 解析器，大大提高了兼容性。
- **详细的日志与报告**: 每次运行都会在 `logs` 目录下生成独立的日志文件，并在控制台打印一份简洁明了的总结报告。

## ❓ 常见问题 (FAQ)

**Q1: 为什么我的 `.mobi` 或 `.azw3` 文件没有被转换？**
**A1:** 请检查以下几点：
  1.  **是否安装 Calibre?** 这是处理这两种格式的必要条件。
  2.  **`ebook-convert` 是否在环境变量中？** 打开命令行，输入 `ebook-convert --version` 看是否能成功返回版本号。如果提示“命令未找到”，请手动将 Calibre 的安装路径添加到系统环境变量 `PATH` 中。
  3.  **文件是否受 DRM 保护？** 如果电子书是加密的（受 DRM 保护），Calibre 将无法转换它。日志文件中通常会有 `DRM`相关的错误提示。

**Q2: 转换过程中出现错误，我该怎么办？**
**A2:** 首先，请查看控制台的红色 `[出错了]` 或 `[致命错]` 信息。然后，打开 `logs` 文件夹下最新生成的 `.log` 文件，它包含了非常详细的错误堆栈信息，可以帮助定位问题。

**Q3: 为什么有的 PDF 文件转换后是空的或者乱码？**
**A3:** 这通常发生在两种情况下：
  1.  PDF 文件本身是“扫描版”的，内容是图片而非可选中的文字。本工具无法进行 OCR（光学字符识别）。
  2.  PDF 文件已加密或损坏。

**Q4: 我可以添加对自己想要的文件格式的支持吗？**
**A4:** 当然可以。这个脚本的设计易于扩展。您只需要：
  1.  编写一个新的处理函数，例如 `handle_my_format(src_path)`，它的返回值需要是 `(text, warnings_list)`。
  2.  在 `PROCESSOR_STRATEGIES` 字典中，将您的文件后缀名映射到这个新函数上，例如 `PROCESSOR_STRATEGIES['.myext'] = handle_my_format`。

======================================================================
# 多格式文档批量转换txt工具 (v1.0)
======================================================================

一个高效、健壮、可扩展的工具，用于将多种格式的文档（如 EPUB, MOBI, PDF, DOCX）批量转换为纯文本（.txt）文件。

## ✨ 主要特性

- **一键启动 (Windows)**: 内置强大的 `run.bat` 启动器，可自动检查环境、支持拖拽操作并提供交互式安全提示，无需任何命令行知识。
- **多格式支持**: 原生支持对 `.epub`, `.docx`, `.pdf` 格式的文本提取，并可借助 Calibre 环境支持 `.mobi` 和 `.azw3` 等更多电子书格式。
- **高性能**: 利用多进程并行处理，能充分利用现代多核 CPU 的性能，大幅缩短大批量文件的转换时间。
- **高度健壮**: 对加密文件、内容为空、格式不规范等异常情况有良好的处理和回退机制，确保单个文件的失败不影响整体任务。
- **用户友好**:
  - **实时进度**: 提供实时进度条（tqdm），直观展示处理进度。
  - **彩色输出**: 在终端使用彩色状态输出，转换结果一目了然。
  - **详细日志**: 为每次运行生成详细的日志报告，便于排查问题。
- **灵活配置**: 支持通过命令行参数自定义并发进程数、超时时间、文件过滤等。
- **安全可靠**: 对于清空输出目录等危险操作，会进行交互式二次确认，防止意外数据丢失。

## 🚀 Windows 快速入门 (使用 run.bat)

我们为 Windows 用户提供了 `run.bat` 一键启动脚本，您可以通过以下两种方式轻松使用：

### 方法一：双击运行 (推荐)

这是最简单的方式，适用于处理固定的 `input` 目录。

1.  **准备文件**: 将所有需要转换的文档放入项目根目录下的 `input` 文件夹。如果该文件夹不存在，请手动创建。
2.  **双击运行**: 直接双击 `run.bat` 文件。
3.  **交互确认**: 如果 `output` 目录已存在，脚本会提示您是否要清空它，请按 `Y` (是) 或 `N` (否) 进行选择。
4.  **自动完成**: 脚本将自动开始转换。完成后，会自动打开存放结果的 `output` 文件夹。

### 方法二：拖拽文件夹

如果您想快速处理任意位置的文件夹，此方法非常方便。

1.  **拖拽操作**: 将任意一个包含待转换文档的文件夹，用鼠标拖到 `run.bat` 文件的图标上，然后松开。
2.  **自动处理**: 脚本会自动将您拖拽的文件夹作为输入目录，并在其旁边创建一个名为 `原文件夹名_output` 的新文件夹来存放转换结果。
3.  **交互与完成**: 后续的交互确认和自动打开结果目录与双击运行模式相同。

## 📚 支持格式

| 格式 | 依赖库/工具 | 处理方式 |
| :--- | :--- | :--- |
| `.epub` | `lxml`, `beautifulsoup4` | **转换为 .txt** (内置解析器) |
| `.docx` | `python-docx` | **转换为 .txt** (内置解析器) |
| `.pdf` | `PyMuPDF` | **转换为 .txt** (内置解析器) |
| `.mobi` | Calibre | **转换为 .txt** (调用 `ebook-convert`) |
| `.azw3` | Calibre | **转换为 .txt** (调用 `ebook-convert`) |
| 其他格式 | _无_ | **直接复制**到输出目录 |

## ⚙️ 环境要求与安装

请按顺序完成以下步骤：

### 步骤 1: 安装 Python

确保您已安装 Python 3.7 或更高版本。
- **下载地址**: [https://www.python.org/](https://www.python.org/)
- **重要**: 安装时，请务必勾选 **"Add Python to PATH"** 或 **"Add python.exe to PATH"** 选项。`run.bat` 脚本依赖此配置来找到 Python 环境。

### 步骤 2: 安装 Python 依赖库

我们强烈推荐使用 `requirements.txt` 文件来一次性安装所有必要的库。在项目根目录下打开命令行（或 PowerShell），运行：

```bash
pip install -r requirements.txt
```

这将会安装包括核心库和所有可选格式支持的库 (`lxml`, `beautifulsoup4`, `tqdm`, `python-docx`, `PyMuPDF`)。

### 步骤 3: 安装 Calibre (可选，用于转换 .mobi/.azw3)

如果您需要转换 `.mobi` 或 `.azw3` 格式，您必须安装 Calibre 软件。

- **下载地址**: [https://calibre-ebook.com/download](https://calibre-ebook.com/download)

**重要提示**: 安装 Calibre 后，请确保其命令行工具 (`ebook-convert`) 所在的路径已被添加到系统的环境变量 `PATH` 中。这通常在安装过程中可以自动完成。您可以在终端中运行 `ebook-convert --version` 来检查是否配置成功。

## ⌨️ 命令行高级用法 (跨平台)

对于 Linux、macOS 用户或希望进行更精细控制的 Windows 高级用户，可以直接使用 `python` 命令来运行主脚本。

**基本用法** (处理 `input` 目录, 输出到 `output` 目录)
```bash
python run.py```

**指定输入/输出目录**
```bash
python run.py ./我的书籍 ./转换结果
```

**指定进程数并清空输出目录** (使用 8 个进程，并在开始前强制清空 `texts` 目录)
> **警告**: `--clean-output` 会删除输出目录下的所有内容，请谨慎使用！
```bash
python run.py ./books ./texts -t 8 --clean-output
```

### 命令行参数详解

| 参数 | 别名 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `input` | | `string` | `input` | 输入目录的路径。 |
| `output` | | `string` | `output` | 输出目录的路径。 |
| `--threads` | `-t` | `int` | 系统CPU核心数 | 用于处理文件的并发进程数量。 |
| `--timeout` | | `int` | `120` | 单个文件的最大处理时间（秒），超时则任务终止。 |
| `--clean-output` | | `flag` | `False` | **危险操作!** 如果指定，将在开始前清空已存在的输出目录。 |
| `--include` | | `string` | `None` | 只处理指定后缀的文件，多个后缀用逗号分隔 (例: `.epub,.pdf`)。 |
| `--exclude` | | `string` | `None` | 排除指定后缀的文件，多个后缀用逗号分隔 (例: `.jpg,.zip`)。 |
| `--no-color` | | `flag` | `False` | 如果指定，禁用所有彩色的控制台输出。 |
| `--help` | `-h` | `flag` | | 显示帮助信息并退出。 |

## 📁 最终目录结构

执行脚本后，您的项目目录将如下所示：
```
.
├── input/            # (双击模式) 你的原始文件放在这里
│   ├── book1.epub
│   └── subfolder/
│       └── report.docx
│
├── output/           # (双击模式) 转换后的 .txt 文件会在这里生成
│   ├── book1.txt
│   └── subfolder/
│       └── report.txt
│
├── logs/             # 日志文件夹
│   └── conversion_YYYYMMDD_HHMMSS.log # 记录了每次运行的详细信息
│
├── run.py            # 主脚本
├── run.bat           # (Windows) 一键运行脚本
└── requirements.txt  # Python 依赖列表
└── README.md         
```

## ❓ 常见问题 (FAQ)

**Q1: 我双击 `run.bat` 后，窗口闪一下就消失了，怎么办？**
**A1:** 这通常是由于环境问题。`run.bat` 启动时会进行检查，如果失败会显示错误信息。请尝试在文件夹的地址栏输入 `cmd` 并回车，然后在打开的命令行窗口中手动输入 `run.bat` 并运行，这样窗口就不会自动关闭，您就可以看到具体的错误提示了。最常见的原因是：
  1.  **Python 未安装** 或 **安装时未勾选 "Add Python to PATH"**。
  2.  在“双击模式”下，项目目录中**不存在 `input` 文件夹**。

**Q2: 为什么我的 `.mobi` 或 `.azw3` 文件没有被转换？**
**A2:** 请检查以下几点：
  1.  **是否安装 Calibre?** 这是处理这两种格式的必要条件。
  2.  **`ebook-convert` 是否在环境变量中？** 打开命令行，输入 `ebook-convert --version` 看是否能成功返回版本号。
  3.  **文件是否受 DRM 保护？** 如果电子书是加密的，Calibre 将无法转换它。日志文件中通常会有 `DRM` 相关的错误提示。

**Q3: 转换过程中出现错误，我该怎么办？**
**A3:** 首先，请查看控制台的红色 `[出错了]` 或 `[致命错]` 信息。然后，打开 `logs` 文件夹下最新生成的 `.log` 文件，它包含了非常详细的错误堆栈信息，可以帮助定位问题。
